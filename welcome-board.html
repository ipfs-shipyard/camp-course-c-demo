<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<!-- TODO: tachyons are good for prototyping, be can move final styles to external file when all is ready  -->
	<!--link href="https://unpkg.com/tachyons@4.11.1/css/tachyons.min.css" rel="stylesheet">
	<link href="https://unpkg.com/ipfs-css@0.12.0/ipfs.css" rel="stylesheet"-->
	<title>Welcome Board</title>
  <link href="./assets/style.css" rel="stylesheet" />
  <style>
    .peerCard {
      width: 200px;
      height: 300px;
      margin-right: 1rem;
    }
    .grid {
      justify-content: flex-start;
    }
  </style>
</head>

<body>
	<header>
		<h1>IPFS Camp 2019: Course C</h1>
  </header>
  <div style="font-size: 4rem; text-align: center; width: 100%; margin-bottom: 1rem;" id="host">
  </div>
  <script>
    document.getElementById("host").textContent = location.host;
  </script>
  <div id="peerBoard-container"></div>
  <script src="https://unpkg.com/ipfs-http-client@32.0.1/dist/index.min.js"></script>
  <script src="/assets/index.min.js"></script>
  <script>
    const httpGateway = 'https://ipfs.io'
    //const websocketStar = '/dnsaddr/ws-star.discovery.libp2p.io/tcp/443/wss/p2p-websocket-star'
    const websocketStar = '/dns4/rendezvous.jimpick.com/tcp/9091/wss/p2p-websocket-star'
    const boostrapNodes = [
      '/dns4/node0.preload.ipfs.io/tcp/443/wss/ipfs/QmZMxNdpMkewiVZLMRxaNxUeZpDUb34pWjZ1kZvsd16Zic',
      '/dns4/node1.preload.ipfs.io/tcp/443/wss/ipfs/Qmbut9Ywz9YEDrz8ySBSgWyJk41Uvm2QJPhwDJzJyGFsD6'
    ]
    const delegateNodes = [
      '/dns4/node1.preload.ipfs.io/tcp/443/https'
    ]

    // start js-ipfs in page context
    var ipfs = new window.Ipfs({
      config: {
        Bootstrap: boostrapNodes,
        Addresses: { Swarm: [websocketStar] },
        /* TODO:
        Delegates: [delegateNodes]
        */
      },
      preload: { enabled: true, addresses: delegateNodes },
      EXPERIMENTAL: {
        ipnsDNS: true,
      }
    })
  </script>
	<script type="module">
		import { html, Component, render } from 'https://unpkg.com/htm@2.1.1/preact/standalone.mjs';

		async function jsonFromIPNS(id, addr) {
			try {
				// ideally: const result = await ipfs.cat(`/ipns/${id}`)
				const result = await ipfs.name.resolve(`/ipns/${id}`)
				if (result) {
					const json = await ipfs.cat(result)
					const data = JSON.parse(json.toString())
					return {
						id,
						addr,
						name: data.name,
						avatar: data.avatar ? await ipfs.cat(data.avatar) : null,
						about: data.about,
						ipns: true
					}
				}
			} catch (err) {
				return {
					id,
					addr
				}
			}
		}

		async function refreshSelf() {
			const { id, addresses } = await ipfs.id()
			const addr = addresses.find(addr => addr.includes(websocketStar) || `(/p2p-circuit/ipfs/${id})`)
			const json = await jsonFromIPNS(id, addr)
			return json
		}

		async function refreshPeers() {
			if (!ipfs || (ipfs.isOnline && !ipfs.isOnline())) return []
			try {
				const peerInfos = await ipfs.swarm.peers()
				const peers = await Promise.all(peerInfos.map(info => jsonFromIPNS(info.peer.toJSON().id, info.addr.toString())))
				return [await refreshSelf(), ...peers]
			} catch (err) {
				console.log(`Problem while refreshing peers: ${err}`)
				return []
			}
		}

		class PeerDashboard extends Component {

			async componentDidMount() {
				const refreshData = async () => {
					const peers = await refreshPeers()
					this.setState({ peers })
				}
				refreshData()
				this.timer = setInterval(refreshData, 3000)
			}

			componentWillUnmount() {
				clearInterval(this.timer)
			}

			render({ }, { peers = [] }) {
				const peerCard = ({ id, name, avatar, addr, about, ipns }) => {
					const avatarUrl = avatar
						? `data:image/*;base64,${avatar.toString('base64')}`
						: `https://proxy.duckduckgo.com/iu/?u=https://robohash.org/${id}.png?set=set4`
					const avatarStyle = avatar
						? `background-image: url('${avatarUrl}');`
						: `background: no-repeat center/80% url('${avatarUrl}');`
					const cardStyle = `peerCard ${ipns ? 'peerWithIpnsManifest' : ''}`
					return html`<div class="${cardStyle}"  title="${addr || id}">
							<div style="${avatarStyle}" class="peerAvatar"></div>
							<div class="peerDetails">
								<h1 title="${name || id}">${name || id}</h1>
								<p title="${about || '(no about)'}">${about || 'No info yet'}</p>
							</div>
						</div>`
				}
				if (!ipfs) return html`<h2>Initialize <code>ipfs</code> first :-)</h2>`
				return html`
				<section id="peerBoard" class="grid">
				  ${peers.length ? '' : html`<h2>Waiting for peer discovery..</h2>`}
					${peers.map(peerCard)}
				</section>`
			}
		}

		render(html`<${PeerDashboard} />`, document.getElementById('peerBoard-container'))
	</script>
	</div>
</body>

</html>
