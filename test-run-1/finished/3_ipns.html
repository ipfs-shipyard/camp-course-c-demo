<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<link href="https://unpkg.com/tachyons@4.11.1/css/tachyons.min.css" rel="stylesheet">
	<link href="https://unpkg.com/ipfs-css@0.12.0/ipfs.css" rel="stylesheet">
	<title>Course C Exercise</title>
	<style>
		.exercise {
			box-shadow: 0 48px 80px -32px rgba(0,0,0,0.3);
			margin-bottom: 80px;
			padding: 2em;
			border: 3px solid #9ad4db;
			border-radius: .5rem;
		}
	</style>
</head>

<body class="sans-serif">
	<header class="pv3 ph2 ph3-l bg-navy cf">
		<img src="https://ipfs.io/images/ipfs-logo.svg" class="dib fr v-mid" style="height:50px">
		<h1 class='aqua fw2 montserrat dib ma0 pv2 ph1 v-mid f3 lh-copy'> IPFS Camp 2019: Course C Exercise <strong>(DRAFT)</strong></h1>
	</header>

	<div class="ph3 mw9">

	<div class="flex">
	  <div class="w-50">
			<h3>Exercises</h3>
			<ol>
				<li><a href="#exercise-1">Talking to API from JS</a></li>
				<li><a href="#exercise-2">Publishing Immutable Data</a></li>
				<li><a href="#exercise-3">Updating Mutable Pointers</a></li>
			</ol>
		</div>
		<div class="w-50">
			<h3>References</h3>
			<ul>
				<li><a href="https://github.com/jimpick/course-c-static">GitHub</a> / <a href="https://codesandbox.io/s/github/jimpick/course-c-static">Codesandbox</a></li>
				<li>node / client: <a href="https://github.com/ipfs/js-ipfs">js-ipfs</a> / <a href="https://github.com/ipfs/js-ipfs-http-client">js-ipfs-http-client</a></li>
				<li>JS API: <a href="https://github.com/ipfs/interface-js-ipfs-core/tree/master/SPEC">interface-js-ipfs-core/SPEC</a></li>
			</ul>
		</div>
	</div>

		<div id="exercise-1" class="exercise">
			<h2>Exercise #1: Talking to API from JS</h2>
			<h3>1. Create API instance (local or remote)</h3>
			<h3>2. Confirm it works by printing <code>ipfs id</code> below:</h3>
			<div class="monospace ba pa3 b--black-20 bg-snow-muted w-100 truncate">
				<pre id="ipfsId">(result of "ipfs id" will appear here)</pre>
			</div>

<script src="https://unpkg.com/ipfs-http-client@32.0.1/dist/index.min.js"></script>
<script src="https://unpkg.com/ipfs@0.36.1/dist/index.min.js"></script>
<script>
	const httpGateway = 'https://ipfs.io'
	const websocketStar = '/dnsaddr/ws-star.discovery.libp2p.io/tcp/443/wss/p2p-websocket-star'
	const boostrapNodes = [
		'/dns4/ams-1.bootstrap.libp2p.io/tcp/443/wss/ipfs/QmSoLer265NRgSp2LA3dPaeykiS1J6DifTC88f5uVQKNAd',
		'/dns4/sfo-3.bootstrap.libp2p.io/tcp/443/wss/ipfs/QmSoLPppuBtQSGwKDZT2M73ULpjvfd3aZ6ha4oFGL1KrGM',
		'/dns4/nyc-2.bootstrap.libp2p.io/tcp/443/wss/ipfs/QmSoLV4Bbm51jM9C4gDYZQ9Cy3U6aXMJDAbzgu2fzaDs64',
		'/dns4/node0.preload.ipfs.io/tcp/443/wss/ipfs/QmZMxNdpMkewiVZLMRxaNxUeZpDUb34pWjZ1kZvsd16Zic',
		'/dns4/node1.preload.ipfs.io/tcp/443/wss/ipfs/Qmbut9Ywz9YEDrz8ySBSgWyJk41Uvm2QJPhwDJzJyGFsD6'
	]

	const ipfs = new window.Ipfs({
		config: {
			Bootstrap: boostrapNodes,
			Addresses: { Swarm: [websocketStar] }
		}
	})

const ipfsId = document.querySelector('#ipfsId')

ipfs.on('ready', () => {
	ipfs.id().then((data) => ipfsId.textContent = JSON.stringify(data,null,2))
})
</script>
		</div>

		<div id="exercise-2" class="exercise">

			<h2>Exercise #2: Publishing Immutable Data (<code class="navy">/ipfs/</code>)</h2>

			<h3>1. Add avatar image to IPFS</h3>
			<form id='addFileInput'>
				<input type='file' class="pointer" /><br />
			</form>
			<a id='addCidOutput' target='_blank' href='' title="Open at HTTP Gateway"></a>
			<script>
				const addFileInput = document.querySelector('#addFileInput')
				addFileInput.addEventListener('change', async event => {
					event.stopPropagation()
					event.preventDefault()
					try {
						const file = event.target.files[0]
						const response = await ipfs.add(file, { progress: (prog) => console.log(`received: ${prog}`) })
						console.log('ipfs.add response', response)
					  const cid = response[0].hash
						const addCidOutput = document.querySelector('#addCidOutput')
					  addCidOutput.href = `${httpGateway}/ipfs/${cid}`
					  addCidOutput.textContent = cid
						document.querySelector('#getButton').disabled = false
					} catch(err) {
					  console.error(err)
					}
				})
			</script>

			<h3>2. Load avatar from IPFS</h3>
			<button id='getButton' type="button" disabled>Get the content</button><br />
			<img id='getImage' class="w4 dib pa2" />
			<script>
				const getButton = document.querySelector('#getButton')
				getButton.addEventListener('click', async event => {
					try {
						// Small images can be inlined using Data URLs (RFC 2397)
						const data = await ipfs.cat(addCidOutput.textContent)
						const img = data.toString('base64')
						document.querySelector('#getImage').src = `data:image/*;base64,${img}`
					} catch(err) {
						console.log(err)
					}
				})
			</script>
		</div>

		<div id="exercise-3" class="exercise">
			<h2>Exercise #3: Updating Mutable Pointers (<code class="navy">/ipns/</code>)</h2>

			<h3>3. Edit below and add to IPFS</h3>
			<textarea id="editJson" name="editJson" rows="5" cols="80" class="monospace mb3 pa2 ba b--black-20 bg-snow-muted w-100">{
"name": "CHANGE_ME",
"avatar": "CHANGE_ME_TO_CID",
"about": "CHANGE_ME"
}</textarea><br />
			<button id="addJson" type="button">Save to IPFS</button><br />
			<a id='jsonCidLink' target='_blank' href=''></a>
			<script>
				const addJsonButton = document.querySelector('#addJson')
				addJsonButton.addEventListener('click', async event => {
					try {
						const textarea = document.querySelector('#editJson')
						const json = window.IpfsHttpClient.Buffer.from(textarea.value)
						const response = await ipfs.add(json, {
							progress: (prog) => console.log(`received: ${prog}`)
						})
						const cid = response[0].hash
						console.log('ipfs.add response', response)
						const jsonCidLink = document.querySelector('#jsonCidLink')
						const publishJson = document.querySelector('#publishJson')
						jsonCidLink.href = `${httpGateway}/ipfs/${cid}`
						jsonCidLink.textContent = cid
						publishJson.disabled = false
					} catch (err) {
						console.error(err)
					}
				})
			</script>

			<h3>4. Publish a reference to the above snapshot at <code class="navy">/ipns/{peerId}</code></h3>
			<button id='publishJson' type="button" disabled>Publish to IPNS</button><br />
			<a id='jsonIpnsLink'></a>
			<script>
				const publishJson = document.querySelector('#publishJson')
				publishJson.addEventListener('click', async event => {
					try {
						const jsonIpnsLink = document.querySelector('#jsonIpnsLink')
						jsonIpnsLink.textContent = 'Publishing...'
						const {name, value} = await ipfs.name.publish(jsonCidLink.textContent)
						jsonIpnsLink.href = `${httpGateway}/ipns/${name}`
						jsonIpnsLink.textContent = `Published ${value} to /ipns/${name}`
					} catch(err) {
						console.log(err)
					}
				})
			</script>

			<h3>5. See the changes on the dashboard</h3>
		</div>

		<h2>Peer Dashboard</h2>
		<div id="peerBoard"></div>

<script type="module">
	import { html, Component, render } from 'https://unpkg.com/htm@2.1.1/preact/standalone.mjs';

	async function jsonFromIPNS(id) {
		try {
			// ideally: const result = await ipfs.cat(`/ipns/${id}`)
			const result = await ipfs.name.resolve(`/ipns/${id}`)
			if ('path' in result) {
				const data = await ipfs.cat(result.path)
				const json = JSON.parse(data.toString())
				json.avatar = await ipfs.cat(json.avatar)
				json.ipns = true
				return json
			}
		} catch (err) {
			if (err.message && err.message.includes('record requested was not found')) return
			console.error(err)
		}
		return {}
	}

	async function refreshSelf() {
		const { id, addresses } = await ipfs.id()
		const addr = addresses.find(addr => addr.includes(websocketStar) || `(/p2p-circuit/ipfs/${id})`)
		const json = await jsonFromIPNS(id)
		return Object.assign({ id, addr }, json)
	}

	async function refreshPeers() {
		const peers = []
		if (ipfs.isOnline && !ipfs.isOnline()) return peers
		peers.push(await refreshSelf())
		try {
			const peerInfos = await ipfs.swarm.peers()
			console.log('refreshPeers â†’ ipfs.swarm.peers()', peerInfos)
			for (let info of peerInfos) {
				const id = info.peer.toJSON().id
				const json = await jsonFromIPNS(id)
				const manifest = Object.assign({
					id,
					addr: info.addr.toString(),
					name: undefined,
					avatar: undefined,
					about: undefined
				}, json)
				peers.push(manifest)
			}
			return peers
		} catch (err) {
			console.error(err)
			return peers
		}
	}

	class PeerDashboard extends Component {

		async componentDidMount() {
			const refreshData = async () => {
				const peers = await refreshPeers()
				this.setState({ peers })
			}
			refreshData()
			this.timer = setInterval(refreshData, 3000)
		}

		componentWillUnmount() {
			clearInterval(this.timer)
		}

		render({}, { peers = [] }) {
			const peerCard = ({id, name, avatar, addr, about, ipns}) => {
				const avatarUrl = avatar
					? `data:image/*;base64,${avatar.toString('base64')}`
					: `https://robohash.org/${id}.png?set=set4`
				const avatarStyle = `background-image: url('${avatarUrl}');background-size: cover;`
				const cardStyle = `grow mw5 center br3 pa3 mv3 ba ${ipns ? 'b--green bg-white bw2 shadow-5' : 'b--black-20 bg-snow-muted'} hover-bg-white`
				return html`<div class="${cardStyle}">
							<div style="${avatarStyle}" class="grow br-100 h4 w4 shadow-5" title="${id}"></div>
							<h1 class="f3 mb2 truncate" title="${name || id}">${name || id}</h1>
							<h2 class="f5 fw4 charcoal-muted mt0 truncate" title="${addr}">${addr}</h2>
							<hr class="dbi mw4 bb bw1 b--black-10" />
						<p class="lh-copy measure center f6 black-70">${about || '(no about)'}</p>
					</div>`
			}
			return html`
				<section class="flex flex-wrap transition-all">
				  ${peers.length ? '' : html`<p>Waiting for peer discovery..</p>`}
					${peers.map(peerCard)}
				</section>`
		}
	}

	render(html`<${PeerDashboard} />`, document.getElementById('peerBoard'))
</script>
</div>
</body>

</html>
