<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<!-- TODO: tachyons are good for prototyping, be can move final styles to external file when all is ready  -->
	<link href="https://unpkg.com/tachyons@4.11.1/css/tachyons.min.css" rel="stylesheet">
	<link href="https://unpkg.com/ipfs-css@0.12.0/ipfs.css" rel="stylesheet">

	<title>Course C Exercise</title>
</head>

<body class="sans-serif">
	<header class="pv3 ph2 ph3-l bg-navy cf">
		<img src="https://ipfs.io/images/ipfs-logo.svg" class="dib fr v-mid" style="height:50px">
		<h1 class='aqua fw2 montserrat dib ma0 pv2 ph1 v-mid f3 lh-copy'> IPFS Camp 2019: Course C Exercise <strong>(DRAFT)</strong></h1>
	</header>

<div class="ph3-l mw9">

	<h2>References</h2>
	<ul>
		<li><a href="https://github.com/jimpick/course-c-static">GitHub</a></li>
		<li><a href="https://codesandbox.io/s/7kzny7rj6q">Codesandbox</a></li>
		<li><a href="https://github.com/ipfs/js-ipfs-http-client">js-ipfs-http-client</a></li>
		<li><a href="https://github.com/ipfs/js-ipfs">js-ipfs</a></li>
	</ul>

	<hr class="mv3 bb bw1 b--black-10">


	<h2>Publishing Immutable Data (<code>/ipfs/</code>)</h2>
	<h3>1. Add avatar image to IPFS</h3>
	<form id='captureMedia'>
		<input type='file' class="pointer" /><br />
	</form>
	<a id='addLink' target='_blank' href='' title="Open at HTTP Gateway"></a>


	<h3>2. Load avatar from IPFS</h3>
	<button id='get' class="pointer">Get the content</button>
	<br />
	<img id='data' class="h4 dib pa2"/>

	<hr class="mv3 bb bw1 b--black-10">

	<h2>Updating Mutable Pointers (<code>/ipns/</code>)</h2>
	<h3>3. Edit below and add to IPFS</h3>
	<div>
	<div>
		<textarea id="editJson" name="editJson" rows="5" cols="80" class="monospace shadow-5 mb3">{
name: 'CHANGE_ME',
avatar: 'CHANGE_ME_TO_CID',
about: 'CHANGE_ME'
}</textarea><br/>
		<button id='addJson'>Save to IPFS</button>
		<br />
		<a id='jsonLink' target='_blank' href=''>
		</a>
	</div>

	<h3>4. Publish a reference to the above snapshot at <code>/ipns/{peerId}</code></h3>
	<div>
		<button id='publish' disabled='true'>Publish to IPNS</button>
		<br />
		<a id='publishLink'></a>
	</div>
	<h3>5. See the changes on the dashboard</h3>


<script src="https://unpkg.com/ipfs-http-client@32.0.1/dist/index.min.js"></script>
<script src="https://unpkg.com/ipfs@0.35.0/dist/index.min.js"></script>
<script>
  const httpGateway = 'https://ipfs.io'
	const ipfs = new window.Ipfs()

	ipfs.on('ready', () => {
	  console.log('ready')
	})
	// const ipfs = window.IpfsHttpClient('localhost', '59685')
	const dom = {
      form: document.querySelector('#captureMedia'),
      addLink: document.querySelector('#addLink'),
      get: document.querySelector('#get'),
      data: document.querySelector('#data'),
			editJson: document.querySelector('#editJson'),
			addJson: document.querySelector('#addJson'),
			jsonLink: document.querySelector('#jsonLink'),
      publish: document.querySelector('#publish'),
      publishLink: document.querySelector('#publishLink'),
			peerBoard: document.querySelector('#peerBoard')
  };

  console.log(dom.form)

  dom.form.addEventListener('change', (event)=> {
    event.stopPropagation()
    event.preventDefault()
    const file = event.target.files[0]

		const addToIpfs = (reader) => {
			const buffer = window.IpfsHttpClient.Buffer.from(reader.result)
	    ipfs.add(buffer, { progress: (prog) => console.log(`received: ${prog}`) })
	      .then((response) => {
	        console.log(response)
	        const cid = response[0].hash
	        console.log(cid)
	        dom.addLink.href = `${httpGateway}/ipfs/${cid}`
	        dom.addLink.textContent= cid
	      }).catch((err) => {
	        console.error(err)
	      })
		}

		// TODO: remove need for reading from reader and pass file object to ipfs.add directly
		const reader = new window.FileReader()
		reader.onloadend = () => addToIpfs(reader)
		reader.readAsArrayBuffer(file)
  })

  dom.get.addEventListener('click', event=> {
    ipfs.cat(dom.addLink.textContent)
    .then(data => {
			// Instead of pointing at HTTP Gateway
			// small images can be inlined using Data URLs (RFC 2397)
			const img = data.toString('base64')
      dom.data.src = "data:image/*;base64," + img;
    })
    .catch(err => console.log(err))
  })

  dom.addJson.addEventListener('click', event=> {
    ipfs.add(window.IpfsHttpClient.Buffer.from(dom.editJson.value), { progress: (prog) => console.log(`received: ${prog}`) })
      .then((response) => {
        console.log(response)
        const cid = response[0].hash
        console.log(cid)
        dom.jsonLink.href = `${httpGateway}/ipfs/${cid}`
        dom.jsonLink.textContent = cid
				dom.publish.disabled = false
      }).catch((err) => {
        console.error(err)
      })
  })

  dom.publish.addEventListener('click', event=> {
    dom.publishLink.textContent = 'Publishing...'
    ipfs.name.publish(dom.jsonLink.textContent)
    .then(({name, value}) => {
			dom.publishLink.href = `${httpGateway}/ipns/${name}`
      dom.publishLink.textContent = `Published ${value} to /ipns/${name}`
    })
    .catch(err => console.log(err))
  })

</script>


<!-- PEER DASHBOARD -->
<hr class="mv3 bb bw1 b--black-10">
	<h2>Peer Dashboard</h2>
	<div id="peerBoard"></div>
<div>

<script type="module">
	import { html, Component, render } from 'https://unpkg.com/htm@2.1.1/preact/standalone.mjs';

	/*
	TODO:
	 - show peers from course only:
	   - filter out bootstrap nodes
	   - show only peers form the same networks
	   - (for course) show only peers from specific ipv4 network (match first octects of IP)
		 - Add green frame/checkbox to nodes that exposed { name, avatar, about } over IPNS
		*/

	async function refreshPeers() {
		try {
			const peers = await ipfs.swarm.peers()
			console.log('refreshPeers().peers', peers)
			if (!peers) return []
			return peers.map(info => {
				return {
					id: info.peer.toJSON().id,
					name: undefined, // TODO
					avatar: undefined, // TODO
					addr: info.addr.toString(),
					about: undefined // TODO
				}
			})
		} catch (err) {
			console.error(err)
			return []
		}
	}

	class PeerDashboard extends Component {

		async componentDidMount() {
			const refreshData = async () => {
				const peers = await refreshPeers()
				this.setState({ peers })
			}
			refreshData()
			this.timer = setInterval(refreshData, 3000)
		}

		componentWillUnmount() {
			clearInterval(this.timer)
		}

		render({}, { peers = [] }) {
			const peerCard = ({id, name, avatar, addr, about}) => {
				const avatarUrl = avatar
					? `${httpGateway}/ipfs/${avatar}`
					: `https://robohash.org/${id}.png?set=set4`
				return html`<div class="mw5 center bg-snow-muted br3 pa3 pa4-ns mv3 ba b--black-10 hover-bg-white">
							<img src="${avatarUrl}" class="br-100 h4 w4 dib ba bg-white b--black-05 pa2 shadow-5" title="${id}" />
							<h1 class="f3 mb2 truncate" title="${name || id}">${name || id}</h1>
							<h2 class="f5 fw4 charcoal-muted mt0 truncate" title="${addr}">${addr}</h2>
							<hr class="mw3 bb bw1 b--black-10" />
						<p class="lh-copy measure center f6 black-70">${about || '(no about)'}</p>
					</div>`
			}
			return html`
				<section class="flex flex-wrap">
				  ${peers.length ? '' : html`<p>Waiting for peer discovery..</p>`}
					${peers.map(peerCard)}
				</section>`
		}
	}

	render(html`<${PeerDashboard} />`, document.getElementById('peerBoard'))
</script>

</body>
</html>
