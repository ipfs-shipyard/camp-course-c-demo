<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Course C Exercise</title>
</head>

<body>
	<h1>Course C Exercise</h1>
	<ul>
		<li><a href="https://github.com/jimpick/course-c-static">GitHub</a></li>
		<li><a href="https://codesandbox.io/s/7kzny7rj6q">Codesandbox</a></li>
		<li><a href="https://github.com/ipfs/js-ipfs-http-client">js-ipfs-http-client</a></li>
		<li><a href="https://github.com/ipfs/js-ipfs">js-ipfs</a></li>
	</ul>

	<hr>

	<div>
		<h3>Upload to IPFS</h3>
		<form id='captureMedia'>
			<input type='file' /><br />
		</form>
		<div>
			<a id='addLink' target='_blank' href=''>
			</a>
		</div>
		<h3>Download from IPFS</h3>
		<div>
			<button id='get'>Get the content</button>
			<br />
			<b id='data'></b>
		</div>
		<h3>Publish to IPNS</h3>
		<div>
			<button id='publish'>publish</button>
			<br />
			<b id='publishLink'></b>
		</div>
	</div>
</body>

<script src="https://unpkg.com/ipfs-http-client/dist/index.min.js"></script>
<script src="https://unpkg.com/ipfs/dist/index.min.js"></script>
<script>
	const ipfs = new window.Ipfs()

ipfs.on('ready', () => {
  console.log('ready')
})
	// const ipfs = window.IpfsHttpClient('localhost', '59685')
	const dom = {
      form: document.querySelector('#captureMedia'),
      addLink: document.querySelector('#addLink'),
      get: document.querySelector('#get'),
      data: document.querySelector('#data'),
      publish: document.querySelector('#publish'),
      publishLink: document.querySelector('#publishLink')
  };

  console.log(dom.form)

  dom.form.addEventListener('change', (event)=> {
    event.stopPropagation()
    event.preventDefault()
    const file = event.target.files[0]
  
    
    ipfs.add(window.IpfsHttpClient.Buffer.from('file.name'), { progress: (prog) => console.log(`received: ${prog}`) })
      .then((response) => {
        console.log(response)
        ipfsId = response[0].hash
        console.log(ipfsId)
        dom.addLink.href = 'https://ipfs.io/ipfs/'+ipfsId 
        dom.addLink.textContent= ipfsId
      }).catch((err) => {
        console.error(err)
      })
  })

  dom.get.addEventListener('click', event=> {
    ipfs.cat(dom.addLink.textContent)
    .then(data => {
      dom.data.textContent = data.toString()
    })
    .catch(err => console.log(err))  
  })

  dom.publish.addEventListener('click', event=> {
    dom.publishLink.textContent = 'Publishing...'
    ipfs.name.publish(dom.addLink.textContent)
    .then(({name, value}) => {
      dom.publishLink.textContent = `Published ${value} to /ipns/${name}` 
    })
    .catch(err => console.log(err))  
  })
</script>

</html>