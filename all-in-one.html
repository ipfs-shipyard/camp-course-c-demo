<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<!-- TODO: tachyons are good for prototyping, be can move final styles to external file when all is ready  -->
	<link href="https://unpkg.com/tachyons@4.11.1/css/tachyons.min.css" rel="stylesheet">
	<link href="https://unpkg.com/ipfs-css@0.12.0/ipfs.css" rel="stylesheet">
	<title>Course C Exercise</title>
	<style>
		.exercise {
			box-shadow: 0 48px 80px -32px rgba(0,0,0,0.3);
			margin-bottom: 80px;
			padding: 2em;
			border: 3px solid #9ad4db;
			border-radius: .5rem;
		}
		#addCidOutput {
			min-width: 30rem;
		}
		#imageFromGateway,
		#imageFromCat {
			min-height: 1em;
			min-width: 1em;
			max-width: 10rem;
			max-height: 10rem;
		}
		#peerInfo  input {
			min-width: 30rem;
		}
	</style>
</head>

<body class="sans-serif">
	<header class="pv3 ph2 ph3-l bg-navy cf">
		<img src="https://ipfs.io/images/ipfs-logo.svg" class="dib fr v-mid" style="height:50px">
		<h1 class='aqua fw2 montserrat dib ma0 pv2 ph1 v-mid f3 lh-copy'> IPFS Camp 2019: Course C Exercise <strong>(DRAFT)</strong></h1>
	</header>

	<div class="ph3 mw9">

	<div class="flex">
	  <div class="w-50">
			<h3>Exercises</h3>
			<ol>
				<li><a href="#exercise-1">Talking to API from JS</a></li>
				<li><a href="#exercise-2">Publishing Immutable Data</a></li>
				<li><a href="#exercise-3">Updating Mutable Pointers</a></li>
			</ol>
		</div>
		<div class="w-50">
			<h3>References</h3>
			<ul>
				<li><a href="https://github.com/jimpick/course-c-static">GitHub</a> / <a href="https://codesandbox.io/s/github/jimpick/course-c-static">Codesandbox</a></li>
				<li>node / client: <a href="https://github.com/ipfs/js-ipfs">js-ipfs</a> / <a href="https://github.com/ipfs/js-ipfs-http-client">js-ipfs-http-client</a></li>
				<li>JS API: <a href="https://github.com/ipfs/interface-js-ipfs-core/tree/master/SPEC">interface-js-ipfs-core/SPEC</a></li>
			</ul>
		</div>
	</div>

		<div id="exercise-1" class="exercise">
			<h2>Exercise #1: Talking to API from JS</h2>
			<h3>1. Create API instance (local or remote)</h3>
			<h3>2. Confirm it works by printing <code>ipfs id</code> below:</h3>
			<div class="monospace ba pa3 b--black-20 bg-snow-muted w-100 truncate">
				<pre id="ipfsId">(result of "ipfs id" will appear here)</pre>
			</div>

<script src="https://unpkg.com/ipfs-http-client@32.0.1/dist/index.min.js"></script>
<script src="https://unpkg.com/ipfs@0.36.1/dist/index.min.js"></script>
<script>
	const httpGateway = 'https://ipfs.io'
	const websocketStar = '/dnsaddr/ws-star.discovery.libp2p.io/tcp/443/wss/p2p-websocket-star'
	const boostrapNodes = [
		'/dns4/node0.preload.ipfs.io/tcp/443/wss/ipfs/QmZMxNdpMkewiVZLMRxaNxUeZpDUb34pWjZ1kZvsd16Zic',
		'/dns4/node1.preload.ipfs.io/tcp/443/wss/ipfs/Qmbut9Ywz9YEDrz8ySBSgWyJk41Uvm2QJPhwDJzJyGFsD6'
	]
	const preloadNodes = [
		'/dnsaddr/node1.preload.ipfs.io/https'
	]

	// start js-ipfs in page context
	var ipfs = new window.Ipfs({
	config: {
			Bootstrap: boostrapNodes,
			Addresses: { Swarm: [websocketStar] }
		},
		preload: { enabled: true, addresses: preloadNodes }
	})

	// OR use js-ipfs-http-client and connect to remote API
	// const ipfs = window.IpfsHttpClient('localhost', '5001')

	const ipfsId = document.querySelector('#ipfsId')

	ipfs.on('ready', () => {
		ipfs.id().then((data) => ipfsId.textContent = JSON.stringify(data,null,2))
	})

</script>
		</div>

		<div id="exercise-2" class="exercise">

			<h2>Exercise #2: Publishing Immutable Data (<code class="navy">/ipfs/</code>)</h2>

			<h3>1. Add avatar image to IPFS</h3>
			<p><input id="addFileInput" type='file' class="pointer" /></p>
			<p>Returned CID: <input id="addCidOutput" readonly /></p>
			<script>
				const addFileInput = document.querySelector('#addFileInput')
				addFileInput.addEventListener('change', async event => {
					event.stopPropagation()
					event.preventDefault()
					try {
						const file = event.target.files[0]
						const response = await ipfs.add(file)
						console.log('ipfs.add response', response)
					  const cid = response[0].hash
						document.querySelector('#addCidOutput').value = cid
					} catch(err) {
					  console.error(err)
					}
				})
			</script>

			<h3>2. Load avatar from IPFS</h3>
			<button id='getButton' type="button">Get the content for CID above</button><br />
			<p>Inlined data: <img id='imageFromCat' /></p>
			<p>Read from HTTP Gateway: <img id='imageFromGateway' /></p>
			<script>
				const getButton = document.querySelector('#getButton')
				getButton.addEventListener('click', async event => {
					try {
						const cid = addCidOutput.value
						const imageViaGateway = document.querySelector('#imageFromGateway')
						imageViaGateway.src = `${httpGateway}/ipfs/${cid}`

						const data = await ipfs.cat(cid)

						// Small images can be inlined using Data URLs (RFC 2397)
						const img = data.toString('base64')
						const imgViaDataURL = document.querySelector('#imageFromCat')
						imgViaDataURL.src = `data:image/*;base64,${img}`
					} catch(err) {
						console.log(err)
					}
				})
			</script>
		</div>

		<div id="exercise-3" class="exercise">
			<h2>Exercise #3: Updating Mutable Pointers (<code class="navy">/ipns/</code>)</h2>

			<h3>3. Edit below and add to IPFS</h3>
			<form id="peerInfo">
				<p>Name: <input id="peerName" /></p>
				<p>Avatar CID: <input id="peerAvatarCid" /></p>
				<p>About: <input id="peerAbout" /></p>
			<form id="peerInfo">
			<pre id="jsonPreview" class="monospace mb3 pa2 ba b--black-20 bg-snow-muted w-100 truncate" >JSON preview will be shown here.</pre><br />
			<button id="addJson" type="button">Add to IPFS</button><br />
			Returned CID: <input id='jsonCid' readonly />
			<script>
				const addJsonButton = document.querySelector('#addJson')
				addJsonButton.addEventListener('click', async event => {
					try {
						const peerName = document.querySelector('#peerName')
						const peerAvatarCid = document.querySelector('#peerAvatarCid')
						const peerAbout = document.querySelector('#peerAbout')
						const jsonPreview = document.querySelector('#jsonPreview')
						jsonPreview.innerText = `{"name":"${peerName.value}", "avatar":"${peerAvatarCid.value}", "about":"${peerAbout.value}"}`
						const json = window.IpfsHttpClient.Buffer.from(jsonPreview.innerText)

						const response = await ipfs.add(json)
						const cid = response[0].hash

						console.log('ipfs.add response', response)
						const jsonCid = document.querySelector('#jsonCid')
						const publishJson = document.querySelector('#publishJson')
						jsonCid.value = cid
						publishJson.disabled = false
					} catch (err) {
						// we don't need to worry about error details in this demo,
						// but try console.error(err) if curious
					}
				})
				const updateJsonPreview = () => {
					jsonPreview.innerText = `{"name":"${peerName.value}", "avatar":"${peerAvatarCid.value}", "about":"${peerAbout.value}"}`
				}
			</script>

			<h3>4. Publish update <code class="navy">/ipns/{peerId}</code> to the above CID</h3>
			<button id='publishJson' type="button" disabled>Publish to IPNS</button><br />
			<div id='ipnsPublishResult'></div>
			<script>
				const publishJson = document.querySelector('#publishJson')
				publishJson.addEventListener('click', async event => {
					try {
						const ipnsPublishResult = document.querySelector('#ipnsPublishResult')
						ipnsPublishResult.textContent = 'Publishing...'
						const cidToPublish = jsonCid.value

						const {name, value} = await ipfs.name.publish(cidToPublish)

						ipnsPublishResult.innerHTML = `<p>Published <strong>${value}</strong><br />under <strong>/ipns/${name}</strong></p>`
					} catch(err) {
						console.log(`Unable to read /ipns/${name}: ${err}`)
					}
				})
			</script>

			<h3>5. Check if update got picked up by the Peer Board</h3>
		</div>

		<h2>Peer Dashboard</h2>
		<div id="peerBoard"></div>

<script type="module">
	import { html, Component, render } from 'https://unpkg.com/htm@2.1.1/preact/standalone.mjs';

	async function jsonFromIPNS(id) {
		try {
			// ideally: const result = await ipfs.cat(`/ipns/${id}`)
			const result = await ipfs.name.resolve(`/ipns/${id}`)
			if ('path' in result) {
				const data = await ipfs.cat(result.path)
				const json = JSON.parse(data.toString())
				json.avatar = await ipfs.cat(json.avatar)
				json.ipns = true
				return json
			}
		} catch (err) {
			if (err.message) {
				if (err.message.includes('record requested was not found')) return
				if (err.message.includes('this dag node is a directory')) return
			}
			console.log(`Unable to read JSON from /ipns/${id}: ${err}`)
		}
		return {}
	}

	async function refreshSelf() {
		const { id, addresses } = await ipfs.id()
		const addr = addresses.find(addr => addr.includes(websocketStar) || `(/p2p-circuit/ipfs/${id})`)
		const json = await jsonFromIPNS(id)
		return Object.assign({ id, addr }, json)
	}

	async function refreshPeers() {
		const peers = []
		if (ipfs.isOnline && !ipfs.isOnline()) return peers
		peers.push(await refreshSelf())
		try {
			const peerInfos = await ipfs.swarm.peers()
			// console.log('refreshPeers â†’ ipfs.swarm.peers()', peerInfos)
			for (let info of peerInfos) {
				const id = info.peer.toJSON().id
				const json = await jsonFromIPNS(id)
				const manifest = Object.assign({
					id,
					addr: info.addr.toString(),
					name: undefined,
					avatar: undefined,
					about: undefined
				}, json)
				peers.push(manifest)
			}
			return peers
		} catch (err) {
			console.log(`Problem while refreshing peers: ${err}`)
			return peers
		}
	}

	class PeerDashboard extends Component {

		async componentDidMount() {
			const refreshData = async () => {
				const peers = await refreshPeers()
				this.setState({ peers })
			}
			refreshData()
			this.timer = setInterval(refreshData, 3000)
		}

		componentWillUnmount() {
			clearInterval(this.timer)
		}

		render({}, { peers = [] }) {
			const peerCard = ({id, name, avatar, addr, about, ipns}) => {
				const avatarUrl = avatar
					? `data:image/*;base64,${avatar.toString('base64')}`
					: `https://robohash.org/${id}.png?set=set4`
				const avatarStyle = `background-image: url('${avatarUrl}');background-size: cover;`
				const cardStyle = `grow mw5 center br3 pa3 mv3 ba ${ipns ? 'b--green bg-white bw2 shadow-5' : 'b--black-20 bg-snow-muted'} hover-bg-white`
				return html`<div class="${cardStyle}"  title="${addr || id}" style="cursor: help; min-width: 270px">
							<div style="${avatarStyle}" class="grow br-100 h4 w4 shadow-5"></div>
							<h1 class="f3 mb2 truncate">${name || id}</h1>
							<hr class="dbi mw4 bb bw1 b--black-10" />
							<p class="lh-copy measure center f6 black-70 truncate">${about || '(no about)'}</p>
						</div>`
			}
			if (!ipfs) return html`<p>Initialize <code>ipfs</code> first :-)</p>`
			return html`
				<section class="flex flex-wrap transition-all">
				  ${peers.length ? '' : html`<p>Waiting for peer discovery..</p>`}
					${peers.map(peerCard)}
				</section>`
		}
	}

	render(html`<${PeerDashboard} />`, document.getElementById('peerBoard'))
</script>
</div>
</body>

</html>
